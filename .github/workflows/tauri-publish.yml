name: Tauri Build and Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: 'x86_64-unknown-linux-gnu'
          - os: windows-latest
            target: 'x86_64-pc-windows-msvc'
          - os: macos-latest
            target: 'x86_64-apple-darwin'
    steps:
      - uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16' # Ensure to use a compatible Node.js version

      - name: Install dependencies
        run: npm install

      - name: Setup Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          default: true
          target: ${{ matrix.target }}
          override: true

      - name: Add Rust target
        run: rustup target add ${{ matrix.target }}

      - name: Build Tauri app
        run: npm run tauri build -- --target ${{ matrix.target }}
        env:
          TAURI_PLATFORM: ${{ matrix.target }}

      - name: Upload Release Asset
        uses: actions/upload-artifact@v2
        with:
          name: ${{ runner.os }}-artifact
          path: src-tauri/target/release/bundle/**


  release:
    needs: [build]
    runs-on: ubuntu-latest
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v2
        with:
          path: downloaded-artifacts

      - name: List downloaded artifacts directory structure
        run: |
          echo "Listing the structure of downloaded-artifacts directory:"
          tree downloaded-artifacts || ls -R downloaded-artifacts

      - name: List contents of each artifact directory
        run: |
          for dir in downloaded-artifacts/*; do
            echo "Listing contents of $dir"
            ls -la "$dir"
          done

      - name: Print environment variables
        run: |
          echo "Listing all environment variables:"
          printenv

      - name: Create Release
        uses: ncipollo/release-action@v1.14.0
        with:
          artifacts: "downloaded-artifacts/*/*.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
          tag: ${{ github.ref }}
          owner: altunenes
          repo: gevende
